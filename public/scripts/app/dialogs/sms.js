define(["app","dialog"],function(a,b){function A(a){INSPARQ.isAPI("/group",{ut:INSPARQ.userToken,action:"remove",channel:"sms",groupName:a})}function z(){INSPARQ.isAPI("/group",{ut:INSPARQ.userToken,action:"get",channel:"sms"},function(b,c){if(b.success===!0&&b.result!==null){INSPARQ.emailgroups=b.result;var d=document.createElement("div");d.className="ins-group-tag-cloud-share",a.text(d,"Share with groups:"),i(".ins-group-tag-cloud")[0].appendChild(d);for(var e in INSPARQ.emailgroups){var f=document.createElement("div");f.className="ins-group-tag-cloud-entry",f.innerHTML='<div class="ins-widget-group-name">'+e+'</div><div class="ins-group-tag-cloud-entry-close"></div>',i(".ins-group-tag-cloud")[0].appendChild(f)}g(i(".ins-widget-group-name"),"click",function(b){var c=a.text(a.target(b)),d=a.trim(h("#ins-phone-number-field").value),e=d.length;e!==0&&d.indexOf("Enter recipient phone number(s), separated by commas")===-1&&d.indexOf("Enter names or phone numbers")===-1?d.charAt(e-1)===","?d+="":d+=",":d="";var f=INSPARQ.emailgroups[c];f.length>1?d+=f.join(","):d+=f[0];var g=d.split(",");d=INSPARQ.unique(g).join(","),h("#ins-phone-number-field").value=d,INSPARQ.moveToEndOfInputField(h("#ins-phone-number-field"))}),g(i(".ins-group-tag-cloud-entry-close"),"click",function(b){var c=a.text(a.target(b).parentNode);A(c),a.remove(a.target(b).parentNode),delete INSPARQ.emailgroups[c];var d=i(".ins-group-tag-cloud > div").length;d<=1&&a.text(i(".ins-group-tag-cloud"),"")})}else a.text(i(".ins-group-tag-cloud"),"")})}function y(){var b=v();if(b.length>160){r("Your message exceeds the maximum length");return!1}if(a.emailValid(h("#ins-phone-number-field").value)){q("You entered an email address. Please enter the recipient's phone number.");return!1}if(!j(a.trim(h("#ins-phone-number-field").value))){q("Please enter a valid phone number.");return!1}toPhones=[],t(h("#ins-phone-number-field").value,toPhones),INSPARQ.lastChannel="sms";if(h("#ins-phone-number-field").value.indexOf("Enter recipient phone number(s), separated by commas")>-1||h("#ins-phone-number-field").value.indexOf("Enter names or phone numbers")>-1){q("You haven't specified any contacts.");return!1}var c=h("#ins-phone-number-field1").value.split(",");if(c.length>1){s("Sorry, you can only enter one phone number in the from field.");return!1}if(a.emailValid(h("#ins-phone-number-field1").value)){s("You entered an email address. Please enter your phone number instead.");return!1}if(!j(a.trim(h("#ins-phone-number-field1").value))||h("#ins-phone-number-field1").value==""){s("Please enter a valid phone number.");return!1}if(toPhones.length>10){q("Sorry, you can only message 10 recipients at a time");return!1}INSPARQ.spin(h("#ins-widget-dialog"),!0),INSPARQ.isAPI("/phonevalidate",{numbers:toPhones},function(a,b){INSPARQ.spin(h("#ins-widget-dialog"),!1);if(a.success===!0){var c=a.result,d="";for(var e=0;e<c.length;e++)c[e]==="invalid"?d+=toPhones[e]+",":c[e]==="landline"&&(d+=toPhones[e]+",");var g=[];t(d,g);var i=INSPARQ.unique(g);if(d!==""){if(i.length<2){q("We can only send text messages to valid mobile numbers: "+i+" is an invalid number. ");return!1}q("We can only send text messages to valid mobile numbers: "+i+" are invalid numbers. ");return!1}var j;INSPARQ.uName?INSPARQ.emailConnectedAs?j=INSPARQ.emailConnectedAs:j=h("#ins-phone-number-field1").value==="Enter your phone number"?"":h("#ins-phone-number-field1").value:j=INSPARQ.uName;var k=v(),l=[];for(var e=0;e<toPhones.length;e++)newPhoneNo=toPhones[e].replace(/[()-./]+/g,""),l.push(newPhoneNo);INSPARQ.spin(h("#ins-widget-dialog"),!0),INSPARQ.recentlySharedContacts=INSPARQ.unique(l),INSPARQ.isAPI("/sms",{ut:INSPARQ.userToken,productID:INSPARQ.productID,fromName:j,toNumbers:INSPARQ.recentlySharedContacts,url:INSPARQ.productUrl,message:INSPARQ.valueParser(k).htmlDecode().purify().value()},function(a,b){INSPARQ.spin(h("#ins-widget-dialog"),!1);if(a.success===!0){INSPARQ.regShare(f,"sms"),INSPARQ.isAPI("/data",{ut:INSPARQ.userToken,action:"tx.addPhone",data:{phone:h("#ins-phone-number-field1").value,name:INSPARQ.uName}},null,null),INSPARQ.emailConnectedAs!=undefined&&INSPARQ.emailConnectedAs!=""&&INSPARQ.isAPI("/data",{ut:INSPARQ.userToken,action:"tx.addEmail",data:{email:INSPARQ.emailConnectedAs,name:INSPARQ.uName}},null,null);if(INSPARQ.pageMode!=="full"){INSPARQ.lastGroupAction="notsaved",INSPARQ.unbindAutoComplete(h("#ins-phone-number-field")),INSPARQ.closeDlgs(),INSPARQ.loadDialog("buyNowDialog");return!0}}},function(a){INSPARQ.spin(h("#ins-widget-dialog"),!1)})}});return!1}function x(){g(h("#ins-phone-number-field"),"focus",function(){a.text(h("#ins-sms-error-message"),"")}),g(h("#ins-phone-number-field1"),"focus",function(){a.text(h("#ins-from-sms-error-message"),"")}),g(h("#ins-text-yourmessage-show-field"),"focus",function(){a.text(h("#ins-message-exceed-error"),"")}),g(h("#ins-gmail-login"),"click",function(){INSPARQ.chooseWebmail("gmail"),n()}),g(h("#ins-yahoo-login"),"click",function(){INSPARQ.chooseWebmail("yahoo"),n()}),g(h("#ins-windowslive-login"),"click",function(){INSPARQ.chooseWebmail("hotmail"),n()}),g(h("#ins-aol-login"),"click",function(){INSPARQ.chooseWebmail("aol"),n()}),g(h("#ins-email-webmail-login-close"),"click",function(){p(),a.show(h("#ins-email-button-bar")),a.hide(h("#ins-email-webmail-login"))}),g(h("#ins-email-webmail-login-close"),"click",function(){p(),a.show(h("#ins-email-button-bar")),a.hide(h("#ins-email-webmail-login"))}),g(h("#ins-connect-button"),"click",function(){a.emailValid(h("#ins-email-webmail-login-name").value)?(p(),w(null)):o("Please enter your full email address, including @"+INSPARQ.activeWebmail+".com")}),g(h("#ins-email-connected-disconnect"),"click",function(){INSPARQ.loginStatus="",u(),w("disconnect"),p()}),g(h("#ins-email-disconnect"),"click",function(){INSPARQ.loginStatus="",u(),w("disconnect"),a.hide(h("#ins-email-disconnect")),p()}),g(h("#ins-send-button"),"click",function(){return y()}),g(h("#ins-email-webmail-login-password"),"keypress",function(b){if(b.which==13){a.preventDefault(b),INSPARQ.triggerEvent(h("#ins-connect-button"),"click");return!1}}),g(h("#ins-text-password"),"focus",function(){a.hide(h("#ins-password-text-div")),a.show(h("#ins-password-div")),h("#ins-email-webmail-login-password").focus()}),g(h("#ins-email-webmail-login-password"),"blur",function(){var b=h("#ins-email-webmail-login-password").value;b.length>0?a.show(h("#ins-password-div")):(a.show(h("#ins-password-text-div")),a.defaultify(h("#ins-text-password")),a.hide(h("#ins-password-div")))}),a.defaultify(h("#ins-email-webmail-login-name"),"Your webmail address"),a.defaultify(h("#ins-text-password"),"Your webmail password"),a.defaultify(h("#ins-phone-number-field1"),"Enter your phone number");var b=INSPARQ.valueParser("data::dialogs-sms-defaults-personal","Check this out.").stripTags().value();a.defaultify(h("#ins-text-yourmessage-hide-field"),b),h("#ins-text-yourmessage-show-field").value=b;var b=INSPARQ.valueParser("data::dialogs-sms-labels-formulaic","$1 on $2").stripTags().fill(INSPARQ.productItemName,INSPARQ.siteDomain).value();h("#ins-text-message-field").value=b+" "+e,g(h("#ins-text-yourmessage-hide-field"),"focus",function(){a.hide(h("#ins-text-yourmessage-hide")),a.show(h("#ins-text-yourmessage-show")),h("#ins-text-yourmessage-show-field").focus()}),g(h("#ins-text-yourmessage-show-field"),"blur",function(b){var c=a.target(b).value;c.length>0?a.show(h("#ins-text-yourmessage-show")):(a.show(h("#ins-text-yourmessage-hide")),a.hide(h("#ins-text-yourmessage-show")))}),g(h("#ins-text-yourmessage-show-field"),"keyup",function(){l()}),g(h("#ins-phone-number-field1"),"keyup",function(){l()}),g(h("#ins-phone-number-field1"),"blur",function(){window.setTimeout(l,100)})}function w(b){INSPARQ.spin(h("#ins-widget-dialog"),!0),INSPARQ.isAPI("/contacts",{plugin:INSPARQ.activeWebmail,ut:INSPARQ.userToken,mode:b,email:h("#ins-email-webmail-login-name").value,password:h("#ins-email-webmail-login-password").value},function(c,d){if(c.success===!0){if(c.result!=null){INSPARQ.emailConnectedAs=c.result.email,b&&(INSPARQ.loginStatus="connected"),a.text(h("#ins-email-connected-as-email"),INSPARQ.emailConnectedAs);var e=c.result.contacts;INSPARQ.acEmailData=[],INSPARQ.acPhoneData=[];var f=INSPARQ.acEmailData,g=INSPARQ.acPhoneData;for(var i in e)for(var j=0;j<e[i].length;j++){var k=e[i];k[j].indexOf(".")<0&&k[j].indexOf("@")<0?g.push('"'+i+'" <'+k[j]+">"):f.push('"'+i+'" <'+k[j]+">")}f.sort(),g.sort(),INSPARQ.acEmailData=f,INSPARQ.acPhoneData=g,INSPARQ.bindAutoCompleteData(INSPARQ.acPhoneData,h("#ins-phone-number-field"))}m()}else o(c.reason);INSPARQ.spin(h("#ins-widget-dialog"),!1)},function(a,b,c){INSPARQ.spin(h("#ins-widget-dialog"),!1),o("Server Problem. Please try again later.")})}function v(){var a="";INSPARQ.uName!==undefined&&INSPARQ.uName!==""?a="Fr "+INSPARQ.uName+": ":INSPARQ.emailConnectedAs!==undefined&&INSPARQ.emailConnectedAs!==""&&(a="Fr "+INSPARQ.emailConnectedAs+": ");var b=h("#ins-phone-number-field1").value==="Enter your phone number"?"":"  Pls reply to: "+h("#ins-phone-number-field1").value,c=h("#ins-text-yourmessage-show-field").value+" "+h("#ins-text-message-field").value+b+".";return a+c}function u(){INSPARQ.acEmailData=[],INSPARQ.acPhoneData=[],INSPARQ.emailConnectedAs="",INSPARQ.unbindAutoComplete(h("#ins-phone-number-field"))}function t(b,c){var d,e,f=/[^a-zA-Z0-9]+/g,g=a.trim(b).split(",");for(var h=0;h<g.length;h++){var i=a.trim(g[h]);i!=""&&(d=i.lastIndexOf("<"),d!=-1?(e=i.substr(d),e=e.replace(">",""),e=e.replace("<","")):e=i,c.push(e))}}function s(b){a.show(h("#ins-from-sms-error-message")),a.text(h("#ins-from-sms-error-message"),b),a.hide(h("#ins-sms-error-message"))}function r(b){p(),a.hide(h("#ins-sms-error-message")),a.show(h("#ins-message-exceed-error")),a.text(h("#ins-message-exceed-error"),b)}function q(b){p(),a.hide(h("#ins-message-exceed-error")),a.hide(h("#ins-from-sms-error-message")),a.show(h("#ins-sms-error-message")),a.text(h("#ins-sms-error-message"),b)}function p(){a.text(h("#ins-email-webmail-login-messages"),""),a.hide(h("#ins-email-webmail-login-messages")),a.hide(h("#ins-sms-error-message")),h("#ins-email-webmail-login").style.height="80px"}function o(b){h("#ins-email-webmail-login").style.height="100px",a.show(h("#ins-email-webmail-login-messages")),a.text(h("#ins-email-webmail-login-messages"),b),a.show(h("#ins-email-webmail-login")),a.hide(h("#ins-sms-error-message"))}function n(){a.show(h("#ins-password-text-div")),a.hide(h("#ins-password-div")),h("#ins-email-webmail-login-password").value="",a.defaultify(h("#ins-email-webmail-login-name"),"Your webmail address"),a.defaultify(h("#ins-text-password"),"Password")}function m(){a.hide(h("#ins-email-webmail-login")),a.hide(h("#ins-email-webmail-login-messages")),h("#ins-email-webmail-login").style.height="80px",INSPARQ.emailConnectedAs!==""?(a.hide(h("#ins-email-first-choose")),a.hide(h("#ins-email-button-bar")),a.show(h("#ins-email-connected")),a.show(h("#ins-email-disconnect")),a.defaultify(h("#ins-phone-number-field"),"Enter names or phone numbers"),l()):(a.show(h("#ins-email-first-choose")),a.show(h("#ins-email-button-bar")),a.hide(h("#ins-email-connected")),a.hide(h("#ins-email-connected-as")),a.defaultify(h("#ins-phone-number-field"),"Enter recipient phone number(s), separated by commas"),l()),INSPARQ.loginStatus=="connected"&&(a.hide(h("#ins-email-connected")),a.show(h("#ins-email-connected-as")),a.hide(h("#ins-email-disconnect")))}function l(){var a=160,b=a-v().length;b<1?h("#ins-counter").innerHTML='<span style="color:#ff0000;">Characters Left: <strong>'+b+"</strong></span>":h("#ins-counter").innerHTML="Characters Left: <strong>"+b+"</strong>"}function k(a,b){if(a.length!=b.length)return!1;var c=a.sort(),d=b.sort();for(var e=0;b[e];e++)if(c[e]!==d[e])return!1;return!0}function j(b){var c,d,e,f=/[^a-zA-Z0-9]+/g,g=/^([+]?[1]( |-)?)?(\(?[0-9]{3}\)?|[0-9]{3})( |-)?([0-9]{3}( |-)?[0-9]{4})$/,h,i=!1;if(b.indexOf(",")!=-1){c=b.split(",");for(var j=0;j<c.length;j++)if(a.trim(c[j])!=""){d=a.trim(c[j]).lastIndexOf("<"),d!=-1?e=a.trim(c[j]).substr(d):e=a.trim(c[j]),e=e.replace("<",""),e=e.replace(">",""),e=a.trim(e),h=g.test(e),e=e.replace(/[()-./]+/g,""),e=e.replace(/\s/g,"");if(h&&e.length>=10&&e.length<=11)i=!0;else{i=!1;return!1}}}else d=a.trim(b).lastIndexOf("<"),d!=-1?e=a.trim(b).substr(d):e=a.trim(b),e=e.replace("<",""),e=e.replace(">",""),e=a.trim(e),h=g.test(e),e=e.replace(/[()-./]+/g,""),e=e.replace(/\s/g,""),h&&e.length>=10&&e.length<=11?i=!0:i=!1;return i}var c={},d='<div id="ins-widget-dialog"><h1 class="ins-header"><span class="inset">Share via SMS</span></h1><div class="ins-widget-content"><div id="ins-email-first-choose" class="ins-widget-headerlabel">Choose friends to share with.</div><div id="ins-email-button-bar"><div id="ins-email-bar-buttons"><div id="ins-email-bar-left"><div id="ins-email-bar-msg">Connect your email account to <span id="ins-email-bar-msg-right"><span class="ins-bold">find friends faster</span>:</span></div><div id="ins-gmail-login" class="ins-email-button-item"><img class="ins-img" src="${serverpath}/images/gmailbutton.png" alt="connect your gmail" /></div><div id="ins-yahoo-login" class="ins-email-button-item"><img class="ins-img" src="${serverpath}/images/yahoobutton.png" alt="connect via yahoo" /></div><div id="ins-windowslive-login" class="ins-email-button-item"><img class="ins-img" src="${serverpath}/images/windowslivebutton.png" alt="connect via windows live" /></div></div></div></div><div id="ins-email-webmail-login"><div id="ins-email-webmail-login-left"><img class="ins-img" src="${serverpath}/images/gmailimg.png" alt="" /></div><div id="ins-email-webmail-login-right">Connect your email account to find your friends. <span class="ins-bold">Faster</span>.<div id="ins-email-webmail-login-close">X</div></div><div id="ins-email-webmail-login-lowerbar"><input id="ins-email-webmail-login-name" type="text" value="" size="44" /><div id="ins-password-text-div"><input type="text" name="ins-text-password" id="ins-text-password" value="" /></div><div id="ins-password-div" style="display:none"><input id="ins-email-webmail-login-password" type="password" value="" size="44" /></div><div id="ins-connect-button"><img class="ins-img" src="${serverpath}/images/connectbutton.png" alt="connect" /></div><div id="ins-email-webmail-login-messages" class="errmsg"></div></div></div><div id="ins-email-disconnect">Disconnect</div><div id="ins-email-connected"><div id="ins-email-connected-left"><img class="ins-img" src="${serverpath}/images/checkmark.png" alt="" /></div><div id="ins-email-connected-right"><span class="ins-bold">Your email address book is connected!</span><br/><span class="ins-f16">Now enter who you want to share the product with:</span></div></div><div id="ins-email-connected-as">You are connected as&nbsp; <span id="ins-email-connected-as-email" style="font-weight:bold"></span> | <span id="ins-email-connected-disconnect">&nbsp;Disconnect</span></div><div class="ins-form-container"><div class="ins-group-tag-ctnr"><div class="ins-group-tag-cloud"></div></div><div class="ins-100percent ins-overflow"><div class="ins-overflow"><div class="ins-form-field"><span class="label">To:</span><span class="warning">Please limit your phone numbers to only <span class="ins-bold">10</span> recipients.</span><textarea id="ins-phone-number-field" name="Message" cols="40" rows="1"></textarea><div id="ins-sms-error-message" style="display:none" class="errmsg"></div></div><div class="ins-form-field"><span class="label">From:</span><textarea id="ins-phone-number-field1" name="Message" cols="40" rows="1"></textarea><div id="ins-from-sms-error-message" style="display:none" class="errmsg"></div></div><div class="ins-form-field"><span class="label">Your message:</span><div id="ins-counter" class="warning">Characters Left: 42</div><div id="ins-text-yourmessage-hide"><textarea id="ins-text-yourmessage-hide-field" cols="40" rows="1" name="Send To"></textarea></div><div id="ins-text-yourmessage-show" style="display:none"><textarea id="ins-text-yourmessage-show-field" cols="40" rows="1" name="Send To"></textarea><div id="ins-message-exceed-error" style="display:none" class="errmsg"></div></div><textarea id="ins-text-message-field" name="Message" cols="40" rows="2" readonly="readonly"></textarea></div><div id="ins-widget-footer"><div id="ins-widget-branding"><a href="http://www.insparq.com/" title="Insparq.com" class="ins-footer-default"><span>Powered by Insparq</span></a></div><div id="ins-send-button" class="blue-button"><span class="inset">Send SMS</span></div></div></div></div></div>',e="",f="",g=a.eventListener,h=a.select,i=a.selectAll;c.init=function(){g(h("#ins-fancybox-tx"),"click",function(){INSPARQ.logAction("widget.buttons.sms.click","SMS button clicked."),INSPARQ.closeDlgs(),INSPARQ.dlg=b({prefix:"isswtx",zindex:1e6,html:INSPARQ.fillTmpl(d,{serverpath:INSPARQ.widgetRoot}),onOpen:function(){INSPARQ.logAction("dialogs.sms.open","Group SMS opened."),w("stored"),m(),a.applyDialogStyles(),a.applyGroupStyles(),a.hide(h("#ins-email-disconnect")),h("#ins-text-message-field").style.backgroundColor="#EDEDED",h("#ins-text-message-field").style.color="#999",INSPARQ.isAPI("/murl",{ut:INSPARQ.userToken,url:INSPARQ.productUrl,productID:INSPARQ.productID,sms_qs:INSPARQ.smsQueryString,channel:"sms"},function(a,b){a.success===!0&&(e=a.result.packedURL,INSPARQ.shareID=a.result.shareID,x(),l())})},onClose:function(){INSPARQ.logAction("dialogs.sms.close","Group SMS closed."),INSPARQ.emailConnectedAs!=""&&(INSPARQ.loginStatus="connected"),INSPARQ.unbindAutoComplete(h("#ins-phone-number-field"))}})})},c.render=function(){var a=INSPARQ.fillTmpl(d,{serverpath:INSPARQ.widgetRoot});h("#ins-fp-widget").innerHTML=a,w("stored"),x()};return c})