define(["app","dialog"],function(a,b){function s(){e(f("#ins-gmail-login"),"click",function(){INSPARQ.logAction("dialogs.email.sections.webmail.buttons.gmail.click","Email Dialog, Web-Mail G-Mail button clicked."),INSPARQ.chooseWebmail("gmail"),j()}),e(f("#ins-yahoo-login"),"click",function(){INSPARQ.logAction("dialogs.email.sections.webmail.buttons.yahoo.click","Email Dialog, Web-Mail Yahoo button clicked."),INSPARQ.chooseWebmail("yahoo"),j()}),e(f("#ins-windowslive-login"),"click",function(){INSPARQ.logAction("dialogs.email.sections.webmail.buttons.hotmail.click","Email Dialog, Web-Mail Hotmail button clicked."),INSPARQ.chooseWebmail("hotmail"),j()}),e(f("#ins-email-webmail-login-close"),"click",function(){INSPARQ.logAction("dialogs.email.sections.webmail.buttons.close.click","Email Dialog, Web-Mail Login closed."),n(),a.show(f("#ins-email-button-bar")),a.hide(f("#ins-email-webmail-login"))}),e(f("#ins-connect-button"),"click",function(){a.emailValid(f("#ins-email-webmail-login-name").value,INSPARQ.activeWebmail)?(n(),q(null)):(INSPARQ.logAction("dialogs.email.sections.webmail.buttons.login.click","Email Dialog, Web-mail Login opened."),k("Please enter your full email address, including @"+INSPARQ.activeWebmail+".com"))}),e(f("#ins-email-connected-disconnect"),"click",function(){INSPARQ.loginStatus="",p(),q("disconnect"),n()}),e(f("#ins-email-disconnect"),"click",function(){INSPARQ.loginStatus="",p(),q("disconnect"),n()}),e(f("#ins-send-button"),"click",function(){if(!a.emailValid(f("#ins-email-addresses-field").value))l("You haven't specified a valid email address.");else{var b=a.trim(f("#ins-email-addresses-field1").value),c=f("#ins-email-addresses-field1").value.split(",");if(b.length==0){m("Enter valid from email address.");return}if(!a.emailValid(b)){m("You haven't specified a valid email address.");return}if(c.length>1&&c[c.length-1]!=""){m("Sorry, you can only enter one email in the from field.");return}var d=[],e=[];o(f("#ins-email-addresses-field").value,e,d);if(d.length==0){l("You haven't specified a valid email address.");return!1}if(d.length>10){l("Sorry, you can only message 10 recipients at a time");return!1}r(e,d,!1),INSPARQ.lastChannel="email",INSPARQ.recentlySharedContacts=INSPARQ.unique(d);if(g(".ins-dialog-checkbox")[0].checked){var i=a.trim(f("#ins-email-addresses-field1").value.replace(",",""));r([i],[i],!0)}for(var j in INSPARQ.emailgroups)if(h(INSPARQ.emailgroups[j],INSPARQ.unique(d))){INSPARQ.lastGroupAction="onemessage",INSPARQ.closeDlgs(),INSPARQ.loadDialog("buyNowDialog");return!0}if(INSPARQ.pageMode!=="full"){INSPARQ.lastGroupAction="onemessage",INSPARQ.closeDlgs(),INSPARQ.loadDialog("buyNowDialog");return!0}}}),e(f("#ins-text-password"),"focus",function(){a.hide(f("#ins-password-text-div")),a.show(f("#ins-password-div")),f("#ins-email-webmail-login-password").focus()}),e(f("#ins-email-addresses-field1"),"focus",function(){a.text(f("#ins-from-email-error-message"),"")}),e(f("#ins-email-webmail-login-password"),"blur",function(){var b=f("#ins-email-webmail-login-password").value;b.length>0?a.show(f("#ins-password-div")):(a.show(f("#ins-password-text-div")),a.defaultify(f("#ins-text-password"),"Password"),a.hide(f("#ins-password-div")))}),a.defaultify(f("#ins-email-webmail-login-name"),"Your email address"),a.defaultify(f("#ins-text-password"),"Password"),a.defaultify(f("#ins-email-addresses-field1"),"Enter your email address");var b=INSPARQ.valueParser("data::dialogs-email-defaults-personal","I'm excited about this product. Check it out.").stripTags().fill(INSPARQ.productItemName,INSPARQ.siteDomain).value();f("#ins-deal-offer-personal-message").value=b,e(f("#ins-email-webmail-login-password"),"keypress",function(b){var c=window.event?b.which:b.keyCode;if(c==13){a.preventDefault(b),INSPARQ.triggerEvent(f("#ins-connect-button"),"click");return!1}})}function r(b,c,d){INSPARQ.logAction("dialogs.email.sending","Sending email from Email Dialog.");var e=(new INSPARQ.valueParser("data::dialogs-email-messages-description","data::dialogs-email-preview-labels-description","data::description-full","data::product-description-full","data::description","data::product-description","schema::Product|description","og::description","meta::description")).stripTags().limit(200).value(),g=INSPARQ.valueParser("data::dialogs-email-labels-header","data::dialogs-email-preview-labels-header","$1 on $2").stripTags().fill(INSPARQ.productItemName,INSPARQ.siteDomain).value(),h="-personalmessage- "+e+" -shareurl-  You received this message from -fromaddr- via inSparq because s/he thought you would be interested in this offer. If you do not wish to receive additional emails from inSparq, please visit: http://www.insparq.com/sharing?email=-toaddr-",i='<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html><head><title>'+INSPARQ.productItemName+'</title></head><body><div>-personalmessage-</div><div id="ins-deal-offer" style="width:98%;margin:10px 0;padding:0;height:80px"><div id="ins-deal-pic" style="float:left; text-align:center;" style="min-width:80px;"><img class="ins-img" src="'+INSPARQ.productImageUrl+'" style="max-width:80px; max-height:80px;" alt="" /></div><div id="ins-deal-offer-text" style="float:left;padding-left:10px"><div id="ins-deal-offer-title" style="font-size:18px;color:#2c6c90;margin-bottom:10px"><a href="-shareurl-">'+g+'</a></div><div id="ins-deal-offer-body" style="font-size:14px;width:300px">'+e+'</div></div></div><div style="float:left"><hr>You received this message from -fromaddr- via inSparq because s/he thought you would be interested in this offer. If you do not wish to receive additional emails from inSparq, please <a href="http://www.insparq.com/sharing?email=-toaddr-">click here</a>.</div></body></html>',j=a.trim(f("#ins-email-addresses-field1").value).replace(",","");j||(INSPARQ.emailConnectedAs?j=INSPARQ.emailConnectedAs:INSPARQ.uID&&(j=INSPARQ.uID)),INSPARQ.isAPI("/email",{ut:INSPARQ.userToken,productID:INSPARQ.productID,shareURL:INSPARQ.shareURL,fromName:INSPARQ.uName,fromAddr:j,toAddr:c,toName:b,subject:INSPARQ.valueParser("data::dialogs-email-labels-subject","Check this out on $2").stripTags().fill(INSPARQ.productItemName,INSPARQ.siteDomain).purify().value(),subst:{personalmessage:f("#ins-deal-offer-personal-message").value,shareurl:INSPARQ.productUrl},body:INSPARQ.valueParser(h).purify().value(),htmlbody:INSPARQ.valueParser(i).purify().value()},function(a,b){if(a.success===!0){INSPARQ.logAction("dialogs.email.sent","Email sent from Email Dialog."),d===!1&&INSPARQ.regShare(INSPARQ.shareID,"email"),INSPARQ.isAPI("/data",{ut:INSPARQ.userToken,action:"em.addEmail",data:{email:j,name:INSPARQ.uName}},null,null);if(INSPARQ.emailConnectedAs!==""){var c=INSPARQ.cookies.get("ud");c.ec=1;var e=new Date;e.setYear(parseInt(e.getFullYear())+1),INSPARQ.cookies.set("ud",c,{expiresAt:e})}INSPARQ.pageMode==="full"&&INSPARQ.alert("Your email message(s) were sent.")}},function(a,b,c){})}function q(b){INSPARQ.spin(f("#ins-widget-dialog"),!0),INSPARQ.isAPI("/contacts",{plugin:INSPARQ.activeWebmail,ut:INSPARQ.userToken,mode:b,email:f("#ins-email-webmail-login-name").value,password:f("#ins-email-webmail-login-password").value},function(c,d){if(c.success===!0){INSPARQ.spin(f("#ins-widget-dialog"),!1),p();if(c.result!==null){INSPARQ.emailConnectedAs=c.result.email,b&&(INSPARQ.loginStatus="connected"),a.text(f("#ins-email-connected-as-email"),INSPARQ.emailConnectedAs);var e=c.result.contacts;INSPARQ.acEmailData=[],INSPARQ.acPhoneData=[];var g=INSPARQ.acEmailData,h=INSPARQ.acPhoneData;for(var j in e)for(var l=0;l<e[j].length;l++){var m=e[j];m[l].indexOf(".")<0&&m[l].indexOf("@")<0?h.push('"'+j+'" <'+m[l]+">"):g.push('"'+j+'" <'+m[l]+">")}g.sort(),h.sort(),INSPARQ.acEmailData=g,INSPARQ.acPhoneData=h,INSPARQ.bindAutoCompleteData(INSPARQ.acEmailData,f("#ins-email-addresses-field"))}i()}else INSPARQ.spin(f("#ins-widget-dialog"),!1),b!=="stored"&&k(c.reason)},function(a,b,c){INSPARQ.spin(f("#ins-widget-dialog"),!1),k("Server Problem. Please try again later.")}),setTimeout(function(){INSPARQ.spin(f("#ins-widget-dialog"),!1)},15e3)}function p(){INSPARQ.acEmailData=[],INSPARQ.acPhoneData=[],INSPARQ.emailConnectedAs="",INSPARQ.unbindAutoComplete(f("#ins-email-addresses-field"))}function o(b,c,d){var e=b.split(/[,\r\n]/);for(var f=0;f<e.length;f++){b=a.trim(e[f]);var g=b.match(/([a-zA-Z0-9@._-]+)+/gi);g!=null&&(g.length>1?g[g.length-1].indexOf("@")>0&&g[g.length-1].indexOf(".")>0&&(d.push(g[g.length-1]),g.pop(),c.push(g.join(" "))):g[0].indexOf("@")>0&&g[0].indexOf(".")>0&&(d.push(g[0]),c.push("")))}}function n(){a.text(f("#ins-email-webmail-login-messages"),""),a.hide(f("#ins-email-webmail-login-messages")),a.hide(f("#ins-email-error-message")),a.hide(f("#ins-from-email-error-message")),f("#ins-email-webmail-login").style.height="80px"}function m(b){n(),a.show(f("#ins-from-email-error-message")),a.text(f("#ins-from-email-error-message"),b)}function l(b){n(),a.show(f("#ins-email-error-message")),a.text(f("#ins-email-error-message"),b)}function k(b){f("#ins-email-webmail-login").style.height="100px",a.show(f("#ins-email-webmail-login-messages")),a.text(f("#ins-email-webmail-login-messages"),b),a.show(f("#ins-email-webmail-login")),a.hide(f("#ins-email-error-message"))}function j(){a.show(f("#ins-password-text-div")),a.hide(f("#ins-password-div")),f("#ins-email-webmail-login-password").value="",a.defaultify(f("#ins-email-webmail-login-name"),"Your email address"),a.defaultify(f("#ins-text-password"),"Password")}function i(){a.hide(f("#ins-email-webmail-login")),a.hide(f("#ins-email-webmail-login-messages")),f("#ins-email-webmail-login")!==null&&(f("#ins-email-webmail-login").style.height="80px"),INSPARQ.emailConnectedAs!==""?(a.hide(f("#ins-email-first-choose")),a.hide(f("#ins-email-button-bar")),a.show(f("#ins-email-connected")),a.show(f("#ins-email-disconnect")),a.defaultify(f("#ins-email-addresses-field"),"Enter recipient name(s) or email address(es)"),f("#ins-email-addresses-field1").value=INSPARQ.emailConnectedAs):(a.show(f("#ins-email-first-choose")),a.show(f("#ins-email-button-bar")),a.hide(f("#ins-email-connected")),a.hide(f("#ins-email-connected-as")),a.hide(f("#ins-email-disconnect")),a.defaultify(f("#ins-email-addresses-field"),"Enter recipient email address(es), separated by commas"),INSPARQ.uID!==""&&(f("#ins-email-addresses-field1").value=INSPARQ.uID));var b=INSPARQ.cookies.get("ud");b.ec!==1,INSPARQ.loginStatus=="connected"&&(a.hide(f("#ins-email-connected")),a.show(f("#ins-email-connected-as")),a.hide(f("#ins-email-disconnect")))}function h(a,b){if(a.length!=b.length)return!1;var c=a.sort(),d=b.sort();for(var e=0;b[e];e++)if(c[e]!==d[e])return!1;return!0}var c={},d='<div id="ins-widget-dialog"><h1 class="ins-header"><span class="inset">Share via E-Mail</span></h1><div class="ins-widget-content"><div id="ins-email-first-choose" class="ins-widget-headerlabel">Choose friends to share with.</div><div id="ins-email-button-bar" style="display:none"><div id="ins-email-bar-buttons"><div id="ins-email-bar-left"><div id="ins-email-bar-msg">Connect your email account to <span id="ins-email-bar-msg-right"><span class="ins-bold">find friends faster</span>:</span></div><div id="ins-gmail-login" class="ins-email-button-item"><img class="ins-img" src="${serverpath}/images/gmailbutton.png" alt="connect your gmail" /></div><div id="ins-yahoo-login" class="ins-email-button-item"><img class="ins-img" src="${serverpath}/images/yahoobutton.png" alt="connect via yahoo" /></div><div id="ins-windowslive-login" class="ins-email-button-item"><img class="ins-img" src="${serverpath}/images/windowslivebutton.png" alt="connect via windows live" /></div></div></div></div><div id="ins-email-webmail-login"><div id="ins-email-webmail-login-left"><img class="ins-img" src="${serverpath}/images/gmailimg.png" alt="" /></div><div id="ins-email-webmail-login-right">Connect your email account to find your friends. <span class="ins-bold">Faster</span>.<div id="ins-email-webmail-login-close">&#215;</div></div><div id="ins-email-webmail-login-lowerbar"><input id="ins-email-webmail-login-name" type="text" value="" size="44" /><div id="ins-password-text-div"><input type="text" name="ins-text-password" id="ins-text-password" value="" /></div><div id="ins-password-div" style="display:none"><input id="ins-email-webmail-login-password" type="password" value="" size="44" /></div><div id="ins-connect-button"><img class="ins-img" src="${serverpath}/images/connectbutton.png" alt="connect" /></div><div id="ins-email-webmail-login-messages" class="errmsg"></div></div></div><div id="ins-email-disconnect" style="display:none">Disconnect</div><div id="ins-email-connected"><div id="ins-email-connected-left"><img class="ins-img" src="${serverpath}/images/checkmark.png" alt="" /></div><div id="ins-email-connected-right"><span class="ins-bold">Your email address book is connected!</span><br/><span class="ins-f16">Now enter who you want to share the product with:</span></div></div><div id="ins-email-connected-as">You are connected as <span id="ins-email-connected-as-email" style="font-weight:bold"></span> | <span id="ins-email-connected-disconnect">&nbsp;Disconnect</span></div><div class="ins-form-container"><div class="ins-group-tag-ctnr"><div class="ins-group-tag-cloud"></div></div><div class="ins-100percent ins-overflow"><div class="ins-form-field"><span class="label">To:</span><span class="warning">Please limit your email to only <span class="ins-bold">10</span> recipients.</span><textarea id="ins-email-addresses-field" name="Message" cols="40" rows="2"></textarea><div id="ins-email-error-message" style="display:none" class="errmsg"></div></div><div class="ins-form-field"><span class="label">From:</span><textarea id="ins-email-addresses-field1" name="Message" cols="40" rows="1"></textarea><div id="ins-from-email-error-message" style="display:none" class="errmsg"></div></div><div class="ins-form-field"><span class="label">Your message:</span><textarea id="ins-deal-offer-personal-message" name="Message" cols="40" rows="3"></textarea></div></div></div><div id="ins-deal-offer"><div id="ins-deal-pic"><img class="ins-img" id="ins-deal-pic-img" src="${insdealpic}" alt=""/></div><div id="ins-deal-offer-text"><div id="ins-deal-offer-title">${insdealtitle}</div><div id="ins-deal-offer-body">${insdealdesc}</div></div></div><div id="ins-widget-footer"><div id="ins-widget-branding"><a href="http://www.insparq.com/" title="Insparq.com" id="ins-default">Powered by Insparq</a></div><div id="ins-send-button" class="blue-button"><span class="inset">Send Email</span></div><div id="ins-email-selfcopy"><input class="ins-dialog-checkbox" type="checkbox" checked="checked" />Send a copy to myself</div></div></div></div>',e=a.eventListener,f=a.select,g=a.selectAll;c.init=function(){e(f("#ins-fancybox-em"),"click",function(){INSPARQ.logAction("widget.buttons.em.click","Email button clicked."),INSPARQ.closeDlgs();var c=INSPARQ.valueParser("data::dialogs-email-messages-description","data::dialogs-email-preview-labels-description","data::description-full","data::product-description-full","data::description","data::product-description","schema::Product|description","og::description","meta::description").stripTags().limit(200).value(),e=INSPARQ.valueParser("data::dialogs-email-labels-header","data::dialogs-email-preview-labels-header","$1 on $2").stripTags().fill(INSPARQ.productItemName,INSPARQ.siteDomain).value();INSPARQ.dlg=b({prefix:"isswem",zindex:1e6,elementsToHide:["#ins-deal-offer"],html:INSPARQ.fillTmpl(d,{serverpath:INSPARQ.widgetRoot,insdealpic:INSPARQ.productImageUrl||INSPARQ.widgetRoot+"/images/addpic.png",insdealtitle:e||"TOKA salon",insdealdesc:c||"Customized Kerastase deep-conditioning treatment, blowout and scalp massage fo r$75"}),onOpen:function(){INSPARQ.logAction("dialogs.email.open","Email Dialog opened."),q("stored"),a.applyDialogStyles(),i(),s(),INSPARQ.isAPI("/murl",{ut:INSPARQ.userToken,url:INSPARQ.productUrl,productID:INSPARQ.productID,email_qs:INSPARQ.emailQueryString,channel:"email"},function(a,b){a.success===!0&&(INSPARQ.shareURL=a.result.packedURL,INSPARQ.shareID=a.result.shareID)},function(a,b,c){})},onClose:function(){INSPARQ.emailConnectedAs!=""&&(INSPARQ.loginStatus="connected"),INSPARQ.unbindAutoComplete(f("#ins-email-addresses-field")),INSPARQ.logAction("dialogs.email.close","Email Dialog closed.")}})})},c.render=function(){panelTemp=INSPARQ.fillTmpl(d,{serverpath:INSPARQ.widgetRoot}),f("#ins-fp-widget").innerHTML(panelTemp),q("stored"),s()};return c})